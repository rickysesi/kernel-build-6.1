name: Android GKI Kernel Builder

on:
  workflow_dispatch:
    inputs:
      kernel_url:
        description: 'Kernel Git URL (Snapdragon 6.1 GKI)'
        required: true
        default: 'https://github.com/MiCode/vendor_kernel_opensource.git'
      kernel_branch:
        description: 'Kernel branch/tag'
        required: true
        default: 'android13-5.15'
      clang_url:
        description: 'Clang/LLVM prebuilt URL (Android NDK recommended)'
        required: true
        default: 'https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r498229b.tar.gz'
      extra_configs:
        description: 'Extra configs URL (optional)'
        required: false
        default: ''
      target_device:
        description: 'Target device name'
        required: false
        default: 'snapdragon_gki'
      enable_ccache:
        description: 'Enable CCache'
        required: false
        default: true
        type: boolean

env:
  BUILD_DIR: ${{ github.workspace }}/build
  KERNEL_DIR: ${{ github.workspace }}/kernel
  TOOLCHAIN_DIR: ${{ github.workspace }}/toolchain
  CLANG_DIR: ${{ github.workspace }}/clang
  CCACHE_DIR: ${{ github.workspace }}/ccache
  ARCH: arm64
  SUBARCH: arm64
  CROSS_COMPILE: aarch64-linux-gnu-
  CROSS_COMPILE_ARM32: arm-linux-gnueabi-
  KERNEL_DEFCONFIG: gki_defconfig

jobs:
  build-gki-kernel:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "KERNEL_URL=${{ github.event.inputs.kernel_url }}" >> $GITHUB_ENV
        echo "KERNEL_BRANCH=${{ github.event.inputs.kernel_branch }}" >> $GITHUB_ENV
        echo "CLANG_URL=${{ github.event.inputs.clang_url }}" >> $GITHUB_ENV
        echo "EXTRA_CONFIGS=${{ github.event.inputs.extra_configs }}" >> $GITHUB_ENV
        echo "TARGET_DEVICE=${{ github.event.inputs.target_device }}" >> $GITHUB_ENV
        
    - name: Install Android GKI build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          curl \
          xz-utils \
          python3 \
          python3-pip \
          python3-dev \
          python-is-python3 \
          bc \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          libncurses-dev \
          libssl-dev \
          rsync \
          kmod \
          cpio \
          lz4 \
          zstd \
          lzop \
          pahole \
          dwarves \
          gcc-multilib \
          g++-multilib \
          ccache \
          ninja-build \
          meson \
          git-lfs \
          device-tree-compiler
        
        # Install Python packages
        pip3 install --upgrade pip
        pip3 install protobuf
        
        # Install specific dependencies for Android builds
        sudo apt-get install -y \
          libxml2-utils \
          xsltproc \
          libswitch-perl \
          zip \
          unzip
        
        # Install AOSP build tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip commandlinetools-linux-9477386_latest.zip
        mkdir -p android-sdk/cmdline-tools
        mv cmdline-tools android-sdk/cmdline-tools/latest
        export ANDROID_SDK_ROOT=$PWD/android-sdk
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
    - name: Setup cross-compilation toolchain
      run: |
        mkdir -p $TOOLCHAIN_DIR
        
        # Install GCC toolchain for ARM64
        if [ ! -d "$TOOLCHAIN_DIR/gcc-arm64" ]; then
          wget https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/heads/main.tar.gz -O gcc-arm64.tar.gz
          tar -xzf gcc-arm64.tar.gz -C $TOOLCHAIN_DIR/gcc-arm64
          rm gcc-arm64.tar.gz
        fi
        
        # Install GCC toolchain for ARM32
        if [ ! -d "$TOOLCHAIN_DIR/gcc-arm" ]; then
          wget https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/+archive/refs/heads/main.tar.gz -O gcc-arm.tar.gz
          tar -xzf gcc-arm.tar.gz -C $TOOLCHAIN_DIR/gcc-arm
          rm gcc-arm.tar.gz
        fi
        
        export PATH="$TOOLCHAIN_DIR/gcc-arm64/bin:$TOOLCHAIN_DIR/gcc-arm/bin:$PATH"
        echo "PATH=$PATH" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-android-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM32=arm-linux-androideabi-" >> $GITHUB_ENV
        
    - name: Download and extract Clang
      run: |
        mkdir -p $CLANG_DIR
        
        echo "Downloading Clang from: $CLANG_URL"
        
        # Handle different archive formats
        if [[ "$CLANG_URL" == *".tar.gz" ]]; then
          wget -q "$CLANG_URL" -O clang.tar.gz
          tar -xzf clang.tar.gz -C $CLANG_DIR --strip-components=1
          rm clang.tar.gz
        elif [[ "$CLANG_URL" == *".tar.xz" ]]; then
          wget -q "$CLANG_URL" -O clang.tar.xz
          tar -xf clang.tar.xz -C $CLANG_DIR --strip-components=1
          rm clang.tar.xz
        elif [[ "$CLANG_URL" == *".zip" ]]; then
          wget -q "$CLANG_URL" -O clang.zip
          unzip -q clang.zip -d $CLANG_DIR
          rm clang.zip
        else
          echo "Unsupported archive format"
          exit 1
        fi
        
        # Find clang binary
        CLANG_PATH=$(find $CLANG_DIR -name "clang" -type f -executable | head -n 1)
        if [ -z "$CLANG_PATH" ]; then
          CLANG_PATH=$(find $CLANG_DIR -name "clang" | head -n 1)
        fi
        
        if [ -n "$CLANG_PATH" ]; then
          CLANG_DIR=$(dirname $(dirname $CLANG_PATH))
          echo "CLANG_DIR=$CLANG_DIR" >> $GITHUB_ENV
          echo "Found Clang at: $CLANG_PATH"
        else
          echo "Clang binary not found!"
          exit 1
        fi
        
        export PATH="$CLANG_DIR/bin:$PATH"
        echo "PATH=$PATH" >> $GITHUB_ENV
        
    - name: Clone kernel source
      run: |
        mkdir -p $KERNEL_DIR
        cd $KERNEL_DIR
        
        echo "Cloning kernel from: $KERNEL_URL"
        echo "Branch: $KERNEL_BRANCH"
        
        # Clone kernel
        git init
        git remote add origin $KERNEL_URL
        git fetch origin $KERNEL_BRANCH --depth=1
        git checkout FETCH_HEAD
        
        # Initialize submodules if they exist
        if [ -f .gitmodules ]; then
          git submodule update --init --recursive --depth=1
        fi
        
    - name: Apply extra configs (if provided)
      run: |
        if [ -n "$EXTRA_CONFIGS" ]; then
          cd $KERNEL_DIR
          echo "Downloading extra configs from: $EXTRA_CONFIGS"
          wget -q "$EXTRA_CONFIGS" -O extra_configs.tar.gz
          tar -xzf extra_configs.tar.gz -C .
          rm extra_configs.tar.gz
          
          # Apply any patches if they exist
          if [ -d "patches" ]; then
            for patch in patches/*.patch; do
              echo "Applying patch: $patch"
              patch -p1 < "$patch" || true
            done
          fi
        fi
        
    - name: Setup CCache
      if: ${{ github.event.inputs.enable_ccache }}
      run: |
        mkdir -p $CCACHE_DIR
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
        
        # Configure CCache
        ccache -o cache_dir=$CCACHE_DIR
        ccache -o max_size=5G
        ccache -z
        
    - name: Configure kernel for GKI
      run: |
        cd $KERNEL_DIR
        
        # Clean previous builds
        make mrproper || true
        
        # Set GKI specific environment variables
        export KBUILD_BUILD_USER=github-actions
        export KBUILD_BUILD_HOST=github
        export LLVM=1
        export LLVM_IAS=1
        
        # For GKI kernels, we need to use the gki_defconfig
        echo "Configuring kernel with $KERNEL_DEFCONFIG..."
        
        # Create necessary directories
        mkdir -p out
        
        # GKI specific configuration
        if [ -f "build.config.gki.aarch64" ]; then
          echo "Using GKI build config..."
          # Use AOSP build method if available
          BUILD_CONFIG=build.config.gki.aarch64
          if [ -f "$BUILD_CONFIG" ]; then
            source $BUILD_CONFIG
          fi
        fi
        
        # Generate defconfig
        make O=out ARCH=$ARCH $KERNEL_DEFCONFIG
        
        # Apply GKI specific configurations
        echo "CONFIG_MODULES=y" >> out/.config
        echo "CONFIG_MODULE_UNLOAD=y" >> out/.config
        echo "CONFIG_MODVERSIONS=y" >> out/.config
        echo "CONFIG_IKCONFIG=y" >> out/.config
        echo "CONFIG_IKCONFIG_PROC=y" >> out/.config
        echo "CONFIG_OVERLAY_FS=y" >> out/.config
        
        # Enable KMI symbols
        echo "CONFIG_UNIX=y" >> out/.config
        echo "CONFIG_INET=y" >> out/.config
        echo "CONFIG_NETFILTER=y" >> out/.config
        
        # Update configuration
        make O=out ARCH=$ARCH olddefconfig
        
    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        
        # Set build variables
        export KBUILD_BUILD_USER=github-actions
        export KBUILD_BUILD_HOST=github
        export LLVM=1
        export LLVM_IAS=1
        export CLANG_TRIPLE=aarch64-linux-gnu-
        
        # Use CCache if enabled
        if [ "$ENABLE_CCACHE" = "true" ]; then
          export CC="ccache clang"
          export CXX="ccache clang++"
        else
          export CC="clang"
          export CXX="clang++"
        fi
        
        echo "Starting kernel build..."
        echo "Using Clang: $(which clang)"
        echo "Clang version:"
        clang --version
        
        # Build kernel
        time make -j$(nproc --all) O=out ARCH=$ARCH \
          CC="$CC" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CROSS_COMPILE_ARM32="$CROSS_COMPILE_ARM32" \
          CLANG_TRIPLE="$CLANG_TRIPLE"
        
        echo "Kernel build completed!"
        
    - name: Build modules
      run: |
        cd $KERNEL_DIR
        
        if [ "$ENABLE_CCACHE" = "true" ]; then
          export CC="ccache clang"
        else
          export CC="clang"
        fi
        
        echo "Building modules..."
        time make -j$(nproc --all) O=out ARCH=$ARCH \
          CC="$CC" \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CROSS_COMPILE_ARM32="$CROSS_COMPILE_ARM32" \
          modules
        
    - name: Package build artifacts
      run: |
        cd $KERNEL_DIR
        
        # Create artifacts directory
        mkdir -p $BUILD_DIR/artifacts
        
        # Copy kernel image
        if [ -f "out/arch/arm64/boot/Image" ]; then
          cp out/arch/arm64/boot/Image $BUILD_DIR/artifacts/Image
          cp out/arch/arm64/boot/Image.gz $BUILD_DIR/artifacts/Image.gz 2>/dev/null || true
          cp out/arch/arm64/boot/Image.gz-dtb $BUILD_DIR/artifacts/Image.gz-dtb 2>/dev/null || true
        fi
        
        # Copy kernel modules
        if [ -d "out/modules" ]; then
          mkdir -p $BUILD_DIR/artifacts/modules
          find out -name "*.ko" -exec cp {} $BUILD_DIR/artifacts/modules/ \;
        fi
        
        # Copy dtb/dtbo if they exist
        if [ -f "out/arch/arm64/boot/dts/vendor/qcom/*.dtb" ]; then
          mkdir -p $BUILD_DIR/artifacts/dtb
          cp out/arch/arm64/boot/dts/vendor/qcom/*.dtb $BUILD_DIR/artifacts/dtb/ 2>/dev/null || true
        fi
        
        # Create build info file
        echo "Kernel Build Information" > $BUILD_DIR/artifacts/build_info.txt
        echo "========================" >> $BUILD_DIR/artifacts/build_info.txt
        echo "Build Date: $(date)" >> $BUILD_DIR/artifacts/build_info.txt
        echo "Kernel URL: $KERNEL_URL" >> $BUILD_DIR/artifacts/build_info.txt
        echo "Kernel Branch: $KERNEL_BRANCH" >> $BUILD_DIR/artifacts/build_info.txt
        echo "Clang URL: $CLANG_URL" >> $BUILD_DIR/artifacts/build_info.txt
        echo "Target Device: $TARGET_DEVICE" >> $BUILD_DIR/artifacts/build_info.txt
        echo "Architecture: $ARCH" >> $BUILD_DIR/artifacts/build_info.txt
        echo "" >> $BUILD_DIR/artifacts/build_info.txt
        
        # Add kernel version info
        if [ -f "out/include/generated/utsrelease.h" ]; then
          echo "Kernel Version:" >> $BUILD_DIR/artifacts/build_info.txt
          grep UTS_RELEASE out/include/generated/utsrelease.h >> $BUILD_DIR/artifacts/build_info.txt
        fi
        
        # Create archive
        cd $BUILD_DIR/artifacts
        tar -czf $BUILD_DIR/kernel_build_$(date +%Y%m%d_%H%M%S).tar.gz .
        
        echo "Artifacts packaged successfully!"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          ${{ env.BUILD_DIR }}/artifacts/
          ${{ env.BUILD_DIR }}/*.tar.gz
        retention-days: 7
        
    - name: Show build summary
      if: always()
      run: |
        echo "========================================"
        echo "         BUILD SUMMARY"
        echo "========================================"
        echo "Kernel Source: $KERNEL_URL"
        echo "Kernel Branch: $KERNEL_BRANCH"
        echo "Clang Toolchain: $CLANG_URL"
        echo "Target: $TARGET_DEVICE (ARM64 GKI)"
        echo "Architecture: $ARCH"
        echo "Build Directory: $BUILD_DIR"
        
        if [ -f "$KERNEL_DIR/out/include/generated/utsrelease.h" ]; then
          echo "Kernel Version:"
          grep UTS_RELEASE $KERNEL_DIR/out/include/generated/utsrelease.h
        fi
        
        echo "========================================"