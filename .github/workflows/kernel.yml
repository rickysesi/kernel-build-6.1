name: GKI Kernel Build

on:
  push:
    branches: [ main, gki-6.1 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version (default: 6.1)'
        default: '6.1'
        required: false
      config_target:
        description: 'Config target (default: gki_defconfig)'
        default: 'peridot_defconfig'
        required: false
      use_clang:
        description: 'Use Clang toolchain'
        default: true
        required: false

env:
  KERNEL_VERSION: "6.1"
  ARCH: "arm64"
  CROSS_COMPILE: "aarch64-linux-gnu-"
  CLANG_TRIPLE: "aarch64-linux-gnu-"
  CLANG_VERSION: "17"
  REPO_URL: "https://github.com/rickysesi/Realking_kernel_peridot"
  BRANCH: "main"
  BUILD_DIR: "${{ github.workspace }}/kernel-build"
  CONFIG_FILE: "peridot_defconfig"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.repo_url || env.REPO_URL }}
        ref: ${{ github.event.inputs.branch || env.BRANCH }}
        submodules: recursive
        fetch-depth: 0

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc \
          bison \
          build-essential \
          cpio \
          flex \
          kmod \
          libelf-dev \
          libssl-dev \
          lz4 \
          lzop \
          libncurses-dev \
          python3 \
          python3-pip \
          git \
          wget \
          gcc-aarch64-linux-gnu \
          libgmp-dev \
          libmpc-dev \
          libmpfr-dev \
          device-tree-compiler
        
        # Install newer clang for GKI builds
        wget https://github.com/llvm/llvm-project/releases/download/llvmorg-${{ env.CLANG_VERSION }}.0.0/clang+llvm-${{ env.CLANG_VERSION }}.0.0-x86_64-linux-gnu-ubuntu-22.04.tar.xz
        tar -xf clang+llvm-${{ env.CLANG_VERSION }}.0.0-x86_64-linux-gnu-ubuntu-22.04.tar.xz
        sudo mv clang+llvm-${{ env.CLANG_VERSION }}.0.0-x86_64-linux-gnu-ubuntu-22.04 /opt/clang-${{ env.CLANG_VERSION }}

    - name: Set environment variables
      run: |
        echo "PATH=/opt/clang-${{ env.CLANG_VERSION }}/bin:${{ github.workspace }}/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin:$PATH" >> $GITHUB_ENV
        echo "CLANG_BIN=/opt/clang-${{ env.CLANG_VERSION }}/bin" >> $GITHUB_ENV
        echo "KERNEL_DIR=${{ github.workspace }}" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV
        echo "LD=ld.lld" >> $GITHUB_ENV
        echo "AR=llvm-ar" >> $GITHUB_ENV
        echo "NM=llvm-nm" >> $GITHUB_ENV
        echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
        echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
        echo "STRIP=llvm-strip" >> $GITHUB_ENV

    - name: Clean kernel tree
      run: |
        cd $KERNEL_DIR
        make mrproper

    - name: Setup config
      run: |
        cd $KERNEL_DIR
        # For GKI builds, we need to set up the proper configuration
        if [ -f "android/abi_gki_aarch64" ]; then
          echo "Setting up GKI configuration..."
          # Build the gki_defconfig with required parameters
          make ARCH=$ARCH CLANG_TRIPLE=$CLANG_TRIPLE CROSS_COMPILE=$CROSS_COMPILE CC=$CC $CONFIG_FILE
        else
          echo "No GKI ABI file found, using standard defconfig"
          make ARCH=$ARCH defconfig
        fi
        
        # Optional: You can modify config here for Snapdragon-specific options
        echo "CONFIG_MODULES=y" >> .config
        echo "CONFIG_MODULE_UNLOAD=y" >> .config
        echo "CONFIG_MODVERSIONS=y" >> .config
        
        # Make olddefconfig to resolve dependencies
        make ARCH=$ARCH CLANG_TRIPLE=$CLANG_TRIPLE CROSS_COMPILE=$CROSS_COMPILE CC=$CC olddefconfig

    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        echo "Starting kernel build..."
        
        # Build with maximum parallel jobs
        nproc_count=$(nproc)
        make -j$((nproc_count * 2)) \
          ARCH=$ARCH \
          CLANG_TRIPLE=$CLANG_TRIPLE \
          CROSS_COMPILE=$CROSS_COMPILE \
          CC="$CC" \
          LD="$LD" \
          AR="$AR" \
          NM="$NM" \
          STRIP="$STRIP" \
          OBJCOPY="$OBJCOPY" \
          OBJDUMP="$OBJDUMP" \
          Image.gz-dtb
        
        # Build modules
        make -j$((nproc_count * 2)) \
          ARCH=$ARCH \
          CLANG_TRIPLE=$CLANG_TRIPLE \
          CROSS_COMPILE=$CROSS_COMPILE \
          CC="$CC" \
          LD="$LD" \
          AR="$AR" \
          NM="$NM" \
          STRIP="$STRIP" \
          OBJCOPY="$OBJCOPY" \
          OBJDUMP="$OBJDUMP" \
          modules
        
        echo "Build completed!"

    - name: Verify build artifacts
      run: |
        cd $KERNEL_DIR
        echo "Checking for build artifacts..."
        
        # Check for key artifacts
        if [ -f "arch/arm64/boot/Image.gz-dtb" ]; then
          echo "✓ Kernel Image.gz-dtb found"
          ls -lh arch/arm64/boot/Image.gz-dtb
        else
          echo "✗ Kernel Image.gz-dtb not found!"
          exit 1
        fi
        
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "✓ Raw kernel Image found"
          ls -lh arch/arm64/boot/Image
        fi
        
        # Check for modules
        if find . -name "*.ko" | head -5; then
          echo "✓ Kernel modules built"
        fi

    - name: Package artifacts
      run: |
        cd $KERNEL_DIR
        mkdir -p artifacts
        
        # Create a build info file
        echo "Build Date: $(date)" > artifacts/build-info.txt
        echo "Commit: ${{ github.sha }}" >> artifacts/build-info.txt
        echo "Kernel Version: $KERNEL_VERSION" >> artifacts/build-info.txt
        echo "Architecture: $ARCH" >> artifacts/build-info.txt
        echo "Toolchain: Clang $CLANG_VERSION" >> artifacts/build-info.txt
        
        # Get kernel version string
        if [ -f "include/config/kernel.release" ]; then
          echo "Kernel Release: $(cat include/config/kernel.release)" >> artifacts/build-info.txt
        fi
        
        # Copy key artifacts
        cp arch/arm64/boot/Image.gz-dtb artifacts/
        cp arch/arm64/boot/Image artifacts/ 2>/dev/null || true
        
        # Copy config
        cp .config artifacts/kernel-config
        
        # Create modules tarball
        mkdir -p artifacts/modules
        make INSTALL_MOD_PATH=artifacts/modules modules_install
        tar -czf artifacts/modules.tar.gz -C artifacts/modules .
        
        # List artifacts
        echo "Artifacts created:"
        ls -lh artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-${{ github.run_id }}
        path: ${{ env.KERNEL_DIR }}/artifacts/
        retention-days: 30

    - name: Create release (optional)
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "Release can be created manually from artifacts"
        echo "Built kernel: Image.gz-dtb and modules.tar.gz"
